{% extends 'base.html.twig' %}

{% block title %}
    Documentation - Modification d'une fiche
{% endblock %}

{% block body %}
<div class="bg-blue-transparent">
    <div class="container mt-0">
 
        {% form_theme form 'documentation/sheet/_collection.html.twig' %}

        {{ form_start(form) }}

            <h1 class="pt-5 mt-0 mb-5">Modification d'une fiche</h1>
        
            <div class="row">
                <div class="col-lg-8 col-md-6">
                    
                    {{ form_widget(form.title) }}

                </div>
                <div class="col-lg-4 col-md-6">
                    <button type="submit" class="btn btn-success success float-right mt-4 white">
                        <i class="fas fa-check white"></i> Ajouter la fiche
                    </button>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-8 col-md-6">
                    <div class="card p-4">
                        <div class="card-body">
                        <h6 class="card-title mb-3"><span class="doc-step"></span> Contenu</h6>
                            {{ form_row(form.content) }}

                        
                        <h6 class="card-title mt-5 mb-3"><span class="doc-step"></span> Outils</h6>
                            <div class="row">
                                <div class="col">
                                    {{ form_row(form.tool, { 'attr': {'size': 10} }) }}
                                </div>
                                <div class="col">
                                    {{ form_row(form.sheetDocuments, { 'attr': {'size': 10} }) }}
                                </div>
                            </div>
                        </div>
                    </div>                    
                </div>
                <div class="col-lg-4 col-md-6">

                    <div class="card p-4">
                        <div class="card-body">
                        <h6 class="card-title mb-3"><span class="doc-step"></span>Entête</h6>
                            {{ form_row(form.subCategory) }}
                            {{ form_row(form.organization) }}

                            <div>Interlocuteurs</div>
                            
                            <div id="interlocutors-message">
                                <p class="text">Aucun organisme sélectionné. Sélectionnez un organisme pour voir la liste des interlocuteurs disponibles.
                                </p>
                            </div>
                            
                            <div class="row" id="interlocutors">
                            </div>
                            
                            {{ form_row(form.headers) }}
                        </div>
                    </div>






                </div>
            </div>

        {{ form_end(form) }}



    </div>
</div>

{% endblock %}

{% block javascripts %}

<script>

$('#add-header').click(function(){

    // Je récupère le numéro des futurs champs que je vais créer
    const index = +$('#widgets-counter').val(); // + transforme la chaine de caractère en nombre

    // Je récupère le prototype des entrées
    const tmpl = $('#sheet_headers').data('prototype').replace(/__h__/g, index); // g = "pour chaque"

    // J'injecte ce code au sein de la div
    $('#sheet_headers').append(tmpl);

    $('#widgets-counter').val(index + 1);

    // Je gère le bouton supprimer
    handleDeleteButtons();

});


function handleDeleteButtons(){
    $('button[data-action="delete"]').click(function(){
        const target = this.dataset.target;

        $(target).remove();

    });

}

function updateCounter(){
    const count = +$('#sheet_headers div.form-group.header').length;

    /* Headers */
    $('#widgets-counter').val(count);

    /* Sections */
    $('#sheet_headers div.form-group.header').each(function( index ) {

        var count_section = +$('#sheet_headers_'+ index +'_sections div.form-group.section').length;

        $('#widgets-section-counter-sheet_headers_'+ index +'_sections').val(count_section);

    });



}

updateCounter();
handleDeleteButtons();



$(document).on('click', '.add-section', function(event){ 

    // Je récupère l'id du header pour savoir dans lequel faut ajouter une ligne
    var id = $(this).attr('id'); // sheet_headers_0_sections
    // id = id.split("_")[2]; // 0

    var header_id = '#' + $(this).attr('id');

    // Je récupère le numéro des futurs champs que je vais créer
    var counter = $('#widgets-section-counter-'+ id).val();

    const index = +counter; // + transforme la chaine de caractère en nombre


    // Je récupère le prototype des entrées
    const tmpl = $(header_id).data('prototype').replace(/__s__/g, index); // g = "pour chaque"

    // J'injecte ce code au sein de la div
    $(header_id).append(tmpl);

    $('#widgets-section-counter-' + id).val(index + 1);

    // Je gère le bouton supprimer
    handleDeleteButtons();
    
});


{# // Fonction permettant de charger les interlocuteurs (quand l'organisme est sélectionné)
function loadInterlocutors() {

    $("#interlocutors-message").html("<p class='text'>Chargement des interlocuteurs en cours... </p>");

    // Si un organisme est selectionné
    var organization_id = $("select#sheet_organization").find("option:selected").val();

    if(organization_id){
        

        var path = "{{ path('interlocutor_load') }}";

        $.ajax({
            type: 'POST',
            url: path,
            data: { id: organization_id},
            success: function(interlocutors) {
                
                // On récupère la liste de tous les interlocuteurs
                var cards = "";
                
                // Pour chaque interlocuteur, on récupère la liste des fiches où ils sont présents.
                for (var item in interlocutors) {

                    // Récupération de l'ID de la fiche
                    var sheet_id = $('.sheet_id').text();

        

                    var checked = "";
                    var label = "Non sélectionné";

                    var sheets = interlocutors[item]['sheets'];

                    // Pour chaque interlocuteur, on vérifie s'il y la fiche correspondante dans sa liste de fiches associées dans $interlocutor->getSheets()
                    if(typeof sheets !== 'undefined'){
                        for (var item2 in sheets){

                            
                            if(sheet_id == sheets[item2]['id']){

                                checked = "checked";
                                label = "Sélectionné"

                            }

                        }
                    }


                    cards += " <div class='col-4'><div class='card'><div class='card-body'><div class='form-group'><label class='interlocutor_label'><input name='interlocutor-" + interlocutors[item]['id'] + "' type='checkbox' value='" + interlocutors[item]['id'] + "' class='interlocutor_checkbox'" + checked + "><span> " + label + " </span></label> <br>" + interlocutors[item]['function'] + "</div><div class='mt-2'><strong>" + interlocutors[item]['firstName'] + " "+ interlocutors[item]['lastName'] + "</strong></div>" + interlocutors[item]['phoneNumber'] + " <br>" + interlocutors[item]['email'] + " <br> </div></div></div>";
                    
                }

                $("#interlocutors").html(cards);
                $("#interlocutors-message").html("<p class='text'>Sélectionnez les interlocuteurs que vous souhaitez joindre à votre fiche.</p>");

                // Gestion des checkbox
                $('.interlocutor_label').click(function () {

                    var checked = $('input', this).is(':checked');

                    $('span', this).text(checked ? ' Sélectionné' : ' Non sélectionné');
                });
                
            },
            error: function(data) {
                console.log(data);
                console.log(data.responseText);
            }


        });

    // Si aucun organisme sélectionné
    }else{
        
        $("#interlocutors-message").html("<p class='text'>Aucun organisme sélectionné. Sélectionnez un organisme pour voir la liste des interlocuteurs disponibles. </p>");
        $("#interlocutors").html("");
    }

} #}

{# // Quand le document a fini de se charger, on charge les interlocuteurs
$(document).ready(function() {
    loadInterlocutors();
});



/* Quand l'organisme change, on change également les interlocuteurs */
$("select#sheet_organization").change(function() {
    loadInterlocutors();
}); #}

// Fonction permettant de charger les interlocuteurs (quand l'organisme est sélectionné)
function loadInterlocutors() {

    $("#interlocutors-message").html("<p class='text'>Chargement des interlocuteurs en cours... </p>");

    // Si un organisme est selectionné
    var organization_id = $("select#sheet_organization").find("option:selected").val();

    if(organization_id){
        
        

        var path = "{{ path('interlocutor_load') }}";

        $.ajax({
            type: 'POST',
            url: path,
            data: { id: organization_id},
            success: function(interlocutors) {


                var cards = "";

                for (var item in interlocutors) {
                    cards += " <div class='col-12'><div class='card'><div class='card-body'><div class='form-group'><label class='interlocutor_label'><input name='interlocutor-" + interlocutors[item]['id'] + "' type='checkbox' value='" + interlocutors[item]['id'] + "' class='interlocutor_checkbox'><span> Non sélectionné </span></label> <br>" + interlocutors[item]['function'] + "</div><div class='mt-2'><strong>" + interlocutors[item]['firstName'] + " "+ interlocutors[item]['lastName'] + "</strong></div>" + interlocutors[item]['phoneNumber'] + " <br>" + interlocutors[item]['email'] + " <br> </div></div></div>";
                    
                }

                $("#interlocutors").html(cards);
                $("#interlocutors-message").html("<p class='text'>Sélectionnez les interlocuteurs que vous souhaitez joindre à votre fiche.</p>");

                // Gestion des checkbox
                $('.interlocutor_label').click(function () {

                    var checked = $('input', this).is(':checked');

                    $('span', this).text(checked ? ' Sélectionné' : ' Non sélectionné');
                });
                
            },
            error: function(data) {
                alert("Error !")
            }


        });

    // Si aucun organisme sélectionné
    }else{
        
        $("#interlocutors-message").html("<p class='text'>Aucun organisme sélectionné. Sélectionnez un organisme pour voir la liste des interlocuteurs disponibles. </p>");
        $("#interlocutors").html("");
    }

}

// Quand le document a fini de se charger, on charge les interlocuteurs
$(document).ready(function() {
    loadInterlocutors();
});



/* Quand l'organisme change, on change également les interlocuteurs */
$("select#sheet_organization").change(function() {
    loadInterlocutors();
});



</script>

{% endblock %}